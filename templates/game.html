{% extends "base.html" %}

{% block content %}
{% if color_scheme %}
<style>
    :root {
        --primary-color: {{ color_scheme.primary_hex }};
        --primary-dark: {{ color_scheme.dark_hex }};
        --primary-light: {{ color_scheme.light_hex }};
        --accent-color: {{ color_scheme.accent_hex }};
    }

    .game-detail {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, #020617 0%, var(--primary-dark) 100%);
    }

    .game-tag {
        background: rgba(var(--primary-rgb), 0.2);
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn.primary {
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    }

    .tracks-section, .reviews-section {
        border-color: var(--primary-color);
    }

    .track-item:hover, .review-item:hover {
        border-color: var(--primary-color);
    }
</style>
{% endif %}
<div class="container">
    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <div class="top-bar">
        <a class="btn" href="{{ url_for('index') }}">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a class="btn primary" href="{{ url_for('edit_game', game_id=game.id) }}">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É
        </a>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–≥—Ä–µ -->
    <div class="game-detail">
        <div class="game-detail-container">
            {% if game.cover %}
            <div class="game-detail-image">
                <img src="{{ url_for('static', filename='covers/' + game.cover) }}" alt="{{ game.title }}">
            </div>
            {% endif %}

            <div class="game-detail-info">
                <div class="game-tags">
                    <div class="game-tag">{{ game.genre }}</div>
                    <div class="game-tag">{{ game.year }}</div>
                    {% if game.playtime %}
                    <div class="game-tag playtime-tag">
                        ‚è±Ô∏è {{ game.playtime }} —á
                    </div>
                    {% endif %}
                </div>

                <p class="game-description">
                    {{ game.description }}
                </p>

                <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–≥—Ä—ã -->
                <form method="post"
                      action="{{ url_for('delete_game', game_id=game.id) }}"
                      onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É –∏ –≤—Å–µ –µ—ë —Ç—Ä–µ–∫–∏?')">
                    <button class="btn danger" type="submit">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É
                    </button>
                </form>

            </div>
        </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —Å OST -->
    <div class="tracks-section">
        <div class="tracks-header">
            <h2>üéµ –°–∞—É–Ω–¥—Ç—Ä–µ–∫–∏ ({{ tracks|length }})</h2>
        </div>

        {% if tracks %}
        <div class="tracks-list">
            {% for track in tracks %}
            <div class="track-item">
                <div class="track-content">
                    <div class="track-icon">üéµ</div>
                    <div class="track-info">
                        <div class="track-name">{{ track.name }}</div>
                        <audio controls>
                            <source src="{{ url_for('static', filename='audio/' + track.file) }}">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                        </audio>
                    </div>
                </div>

                <form method="post"
                      action="{{ url_for('delete_track', track_id=track.id, game_id=game.id) }}"
                      onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–∫?')">
                    <button class="btn danger" type="submit">
                        ‚ùå –£–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-tracks">
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–∞—É–Ω–¥—Ç—Ä–µ–∫–æ–≤</p>
        </div>
        {% endif %}

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫–∞ -->
        <div class="add-track-form">
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç—Ä–µ–∫</h3>
            <form method="post"
                  action="{{ url_for('add_track', game_id=game.id) }}"
                  enctype="multipart/form-data"
                  class="form-card">
                <div class="track-form-grid">
                    <div>
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞:</label>
                        <input type="text" name="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Main Theme" required>
                    </div>
                    <div>
                        <label>–ê—É–¥–∏–æ —Ñ–∞–π–ª (MP3):</label>
                        <input type="file" name="file" accept=".mp3" required>
                    </div>
                </div>
                <button class="btn wide" type="submit">
                    üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫
                </button>
            </form>
        </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è —Å –∑–∞–º–µ—Ç–∫–∞–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—Å) -->
    <div class="reviews-section">
        <div class="reviews-header">
            <h2>üìù –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏ –æ–± –∏–≥—Ä–µ
                {% if avg_rating > 0 %}
                <span class="avg-rating">‚òÖ {{ avg_rating }}/5</span>
                {% endif %}
            </h2>
            <span class="reviews-count">{{ reviews|length }} –∑–∞–º–µ—Ç–æ–∫</span>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏ -->
        <div class="add-review-form">
            <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</h3>
            <form method="post"
                action="{{ url_for('add_review', game_id=game.id) }}"
                enctype="multipart/form-data"
                class="form-card">
            <div>
                <label>–ú–æ—è –æ—Ü–µ–Ω–∫–∞:</label>
                <select name="rating" required>
                    <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É</option>
                    <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ - –û—Ç–ª–∏—á–Ω–æ</option>
                    <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ - –•–æ—Ä–æ—à–æ</option>
                    <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ - –ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                    <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ - –ü–ª–æ—Ö–æ</option>
                    <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ - –£–∂–∞—Å–Ω–æ</option>
                </select>
            </div>
            <div>
                <label>–ú–æ–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è:</label>
                <textarea name="text" placeholder="–ß—Ç–æ –¥—É–º–∞—é –æ–± —ç—Ç–æ–π –∏–≥—Ä–µ? –ö–∞–∫–∏–µ —Ç—Ä–µ–∫–∏ –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å?"
                      rows="3" required></textarea>
            </div>
            <div>
                <label>–î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç/—Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <input type="file" name="image" accept=".jpg,.png,.jpeg,.gif,.webp">
                <div style="color: #94a3b8; font-size: 12px; margin-top: 5px;">
                    üí° –ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–≥—Ä—ã, —Ñ–æ—Ç–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ —Ç.–¥.
                </div>
            </div>
            <button class="btn wide" type="submit">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
            </button>
        </form>
    </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫ -->
        {% if reviews %}
        <div class="reviews-list">
            {% for review in reviews %}
            <div class="review-item">
                <div class="review-header">
                    <div class="review-meta">
                        <div class="review-rating">
                            {% for i in range(5) %}
                                {% if i < review.rating %}
                                <span class="star filled">‚òÖ</span>
                                {% else %}
                                <span class="star">‚òÜ</span>
                                {% endif %}
                            {% endfor %}
                            <span class="rating-number">{{ review.rating }}/5</span>
                        </div>
                        {% if review.created_at %}
                        <div class="review-date">
                            üìÖ {{ review.created_at[:10] }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                {% if review.image %}
                <div class="review-image-container">
                    <img src="{{ url_for('static', filename='review_images/' + review.image) }}"
                         alt="–°–∫—Ä–∏–Ω—à–æ—Ç"
                         class="review-image"
                         onclick="openImageModal('{{ url_for('static', filename='review_images/' + review.image) }}')">
                </div>
                {% endif %}

                <div class="review-text">
                    {{ review.text }}
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                <form method="post"
                      action="{{ url_for('delete_review', review_id=review.id, game_id=game.id) }}"
                      onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?')"
                      style="margin-top: 10px; text-align: right;">
                    <button type="submit" class="btn danger" style="padding: 5px 10px; font-size: 12px;">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-reviews">
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<div id="imageModal" class="modal">
    <span class="close" onclick="closeImageModal()">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function openImageModal(imageSrc) {
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImage");
    modal.style.display = "block";
    modalImg.src = imageSrc;
}

function closeImageModal() {
    document.getElementById("imageModal").style.display = "none";
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
window.onclick = function(event) {
    const modal = document.getElementById("imageModal");
    if (event.target == modal) {
        closeImageModal();
    }
}
</script>
{% endblock %}